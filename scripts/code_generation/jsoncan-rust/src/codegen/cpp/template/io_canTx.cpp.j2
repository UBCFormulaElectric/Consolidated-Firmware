/**
 * @note This file is auto-generated. Do not modify!
 */
// clang-format off

/* ------------------------------- Includes ------------------------------- */

#include "io_canTx.hpp"
#include <string.h>
#include "app_canTx.hpp"
#include "app_canUtils.hpp"

#ifdef THREAD_SAFE_CAN_PACKING
void (*lock)(void);
void (*unlock)(void); 

void io_canTx_set_lockfunction(
    void (*lock_in)(void),
    void (*unlock_in)(void)
)
{
    lock = lock_in;
    unlock = unlock_in;
}
#endif

namespace io::can_tx {
/* --------------------------- Static Variables --------------------------- */
{% for bus in node_buses %}
static uint32_t can_mode_{{bus.name}};
static void (*transmit_func_{{bus.name}})(const JsonCanMsg* tx_msg);
{% endfor %}

/* --------------------- Static Function Definitions ---------------------- */

{% for (msg, busses) in messages %}
{%- if msg.cycle_time.is_some() -%}
static void sendPeriodic_{{msg.name}}()
{%- else -%}
void sendAperiodic_{{msg.name}}()
{%- endif %}
{
    JsonCanMsg tx_msg;
    memset(&tx_msg, 0, sizeof(JsonCanMsg));
    tx_msg.std_id = {{msg.id_macro()}};
    tx_msg.dlc = {{msg.dlc_macro()}};
    #ifdef THREAD_SAFE_CAN_PACKING
    lock();
    #endif
    app::can_utils::pack(app::can_tx::getData_{{msg.name}}(), tx_msg.data);
    #ifdef THREAD_SAFE_CAN_PACKING
    unlock();
    #endif
    {%- for msg_bus_name in busses %}
    if (
    {%- for mode in msg.modes %}
        can_mode_{{msg_bus_name}} & (static_cast<uint32_t>({{msg_bus_name}}Mode::{{mode}}))
    {%- endfor %}
    )
    {
        transmit_func_{{msg_bus_name}}(&tx_msg);
    }
    {%- endfor %}
}
{% endfor %}


/* --------------------- Public Function Definitions ---------------------- */

void init( 
    {% for bus in node_buses -%}
    void (*transmit_{{bus.name}}_msg_func)(const JsonCanMsg*) {%- if !loop.last -%}, {%- endif -%}
    {%- endfor %}
)
{
    {%- for bus in node_buses %}
    transmit_func_{{bus.name}} = transmit_{{bus.name}}_msg_func;
    {%- endfor %}
}


{% for bus in node_buses -%}
void enableMode_{{bus.name}}({{bus.name}}Mode mode, bool enable)
{
    if (enable)
    {
        can_mode_{{bus.name}} |= (uint32_t)mode; // Enable mode
    }
    else
    {
        can_mode_{{bus.name}} &= ~((uint32_t)mode); // Disable mode
    }
}
{%- endfor %}



void enqueue1HzMsgs()
{
    {% for (msg, busses) in messages if msg.cycle_time.is_some() && msg.cycle_time.unwrap() == 1000 -%}
    sendPeriodic_{{ msg.name }}();
    {%- endfor %}
}

void enqueue100HzMsgs()
{
    {%- for (msg, busses) in messages if msg.cycle_time.is_some() && msg.cycle_time.unwrap() == 10 %}
    sendPeriodic_{{ msg.name }}();
    {%- endfor %}
}

void enqueueOtherPeriodicMsgs(uint32_t time_ms)
{
    {%- for (msg, busses) in messages if msg.cycle_time.is_some() && msg.cycle_time.unwrap() != 1000 && msg.cycle_time.unwrap() != 10 %}
    if (time_ms % {{msg.cycle_time_macro()}} == 0)
    {
        sendPeriodic_{{msg.name}}();
    }
    {%- endfor %}
}
}