# Note: Setting `sudo` to `required` will add 20-50s to CI image boot time
os: linux
dist: bionic
sudo: false
language: python
python: "3.6"

git:
  submodules: false

env:
  global:
    - INSTALL_DIR=/usr/local
    - CUBE_INSTALL_DIR=$INSTALL_DIR/STM32CubeMX
    - PYTHONPATH=$PWD
    - secure: lJpBI5yEBcbIMOXQv2P3T9f2Dl3rgQqk2SWHCaewyFnpco0C41SWdZswS3V+R53w0Q+C+M4kECtMyLNgsV7mqu8+5NH/+mTP9eyXtcAxQS2WHeGT5BFniULoR5UBnB0t0dyj0nfute5rwnxvVf4LD038SwGRG8gjFsTFgcgNfehN+OgIK2nNKxddg5mQ3nKfZINY8heCmN11S3tZt7k2WRgVC/reOXtPDgdeUQXmr+QSatL4b15F5WmDpOSFMXurVGuNOn7J8YX5C9Ly6ydE3BHlblDDZotHmzfnAz37Kr2H6iJR3PrHcbRzMdA6/obf21RVq343c2wtcOSQL6fXkHc06RiplI6Cq0djBYtXPtTz2pAVJNNLCzTT9+wmWEIOTqx3u4ngpx9mIvLBonLVKkwT95Jd/8U4xzYDGakFj0dfBiMxi2JwwDOC6CpXbVckOqGhEkS15JkeGzRAZ3WN8o/kR+QDdu5jYbUfoV47vb2WrA2AuioS7ltp/GWeRuGtMm+SACSiAqZ5KkbT0PRYpAx8NPEgqWZxmfOwZDJRRaTlyH6Ix2emrGSnjmDT1b8KaFNwSf8/t0uduaDbRn8zaGFnXY+Qbcs7P59TTvaQDvHE8rGWJbpvPVk4GJShRk6xiVkcx6++UM+U/IBxm+WSotZkzRhgj/zHl+zLJJQG18o=
    - secure: "ps6vJ6bJAyrMMFwPMAcQjQRmhEayN/UCaFt2im1BxqI3tBNaYGKiuC0T9VKj0nlaZG7eIDwO0PiF7/UESRT44NmyVap8Wvg4boPeFcV3TIqARHoMQEuAaDOD2EyMszhbN6tP0pUFynO7FPV1DWRNCIaGdU/FzWm8DwBvnwywJtBSTzaoyMH2VFMAq+XeHe2/qJxdvfCSXbxav3mlxVsKBCz9rmbLA65AOfxsOji8PsuwfWBVMzRlCAQAb9cgJmT+yyRBwTcr7/hy3wZhi7h0YX/Kdl2TOR6oQrM85YEKw+so+kYEP0/ZcHsE+VQ8YWZ+BDNbVX94q1HBKNmTZjSO6c5wPMbaifuOiCAcCYvJ99OZnqpsRxSxlHGC36+wLdk8/eRzWLq04m48ZL6BbzWTGTTsvKyUQKWnLstXJoehSgg0LAUzqAE2QfmNfiJ0y4ZrqwggzDa+3doi06GiVWnMq6mdeQjE6BIeszqpUabEx1EUxBkL16oXsAGzcyfnd2xIq6E6y5ePX2+JHZvBFkb2qJUe3qOjzMPRDJjxS2xweRNYH1Yji7fkOu0j2Q0IraBhopkSRzhpSeV8GsuNoOKVsiNVY7gtCb1UgGd83P37VKYO/Sp4DrgckZWaBzoLLiK28Pbz92t8RBtd6AtWC3hTQ/CfTP9p2rGSkcuD2zp/Y7E="

services:
  # Use xvfb to run programs requiring a GUI (e.g. STM32CubeMX code generation)
  - xvfb
before_install:
  - ./scripts/travis_ci/pull_git_submodules.sh
  - pip install pipenv
  - git lfs pull

install:
  - pipenv install
  # Modify $PATH directly in .travis.yml because a child process (i.e.
  # travis_install_binaries.sh) can't modify the environmental variables of its
  # parent process (i.e. .travis.yml)
  - PATH=$INSTALL_DIR/bin:$CUBE_INSTALL_DIR:$PATH && ./scripts/travis_ci/travis_install_binaries.sh $INSTALL_DIR $CUBE_INSTALL_DIR

addons:
  apt_packages:
    # The GCC ARM embedded toolchain is 32-bit while the Travis CI environment
    # is 64-bit. Therefore, we require the following libraries to be installed.
    - libbz2-1.0:i386
    - libncurses5:i386
    - libz1:i386

before_script:
  - ./scripts/travis_ci/print_bin_versions.sh

script:
  - echo $SeriesCI_Token
  - echo ${SeriesCI_Token}
  - echo $SERIESCI_TOKEN
  - ./scripts/travis_ci/travis_script.sh $CUBE_INSTALL_DIR/STM32CubeMX

matrix:
  include:
    - name: "Build ARM Executables"
      env: RUN_ARM_BUILD="true"
    - name: "Build and Run x86 Tests"
      env: RUN_X86_TESTS="true"
    - name: "Check Formatting"
      env: RUN_FORMATTING_CHECKS="true"
    - name: "Check STM32CubeMX Code Generation"
      env: RUN_CUBE_CODEGEN_CHECKS="true"
