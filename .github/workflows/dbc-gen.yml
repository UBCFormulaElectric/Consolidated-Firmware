name: DBC Generation on Pull Request + CI passed
run-name: ${{ github.actor }} has set up a pull request 
on:
  workflow_run:
    workflows: [UBC Formula Electric CI]
    types:
      - completed

jobs:
  # build:
  #   uses: UBCFormulaElectric/Consolidated-Firmware/.github/workflows/build.yml@master
  #   secrets:
  #     docker_token: ${{secrets.DOCKER_TOKEN}}
  #   with:
  #     upload_artifact: true
  generate-dbc:
    name: Generate CAN DBC file
    runs-on: ubuntu-22.04
    container:
      image: ubcformulaelectric/environment:latest
      credentials:
        username: ubcformulaelectric
        password: ${{ secrets.docker_token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with: # TODO check if submodules are required (can be optimized away) (From bin-dbc-gen)
          submodules: recursive
      - name: Generate DBC
        run: |
          python3 scripts/code_generation/jsoncan/generate_can_from_json.py --only_dbc --can_data_dir "can_bus/json" --dbc_output "can_bus/dbcs/CanMsgs.dbc"
      - name: Upload DBC to Artifact
        uses: actions/upload-artifact@v2
        with:
          name: CanMsgs.dbc
          path: ./can_bus/dbcs/CanMsgs.dbc
  make-release:
    name: Add DBC to Pull_Request-specific release
    runs-on: ubuntu-22.04
    needs: generate-dbc
    steps:
      - name: Download DBC from artifact
        uses: actions/download-artifact@v2
      - name: Create Release
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          title: "DBC"
          tag: ${{ github.sha }}
          prerelease: false
          files: |
            CanMsgs.dbc
